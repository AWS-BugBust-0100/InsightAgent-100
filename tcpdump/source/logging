
. $(command -p find .. -maxdepth 3 -type f -name ifstdlib -print -quit)

:unwind_stack() {
    local script="${BASH_SOURCE[-1]}"
    local func="${FUNCNAME[-2]}"
    local lineno="${BASH_LINENO[-3]}"
    local stack="${script}:${func##*/}():${lineno}"
    local len="${#BASH_SOURCE[@]}"
    for i in $(seq -2 -1 $(( -len + 4 ))); do
        script="${BASH_SOURCE[i]}"
        func="${FUNCNAME[(( i - 1 ))]}"
        lineno="${BASH_LINENO[(( i - 2 ))]}"
        stack="${stack}->${script}:${func##*/}():${lineno}"
    done
    echo "${stack}"
}

:log() {
    local message=( $(:args "$@") )
    local log_lvl="${message[0]}"; unset 'message[0]'
    local log_msg="${message[@]}"
    local log="[pid $$] ${log_lvl} $(:unwind_stack) ${log_msg}"
    logger "${log}"
    echo "$(date +'%Y-%m-%dT%H:%M:%SZ') ${log}"
}

:debug() {
    if [[ "${DEBUG:-0}" -eq 1 ]]; then
        :log "DBUG" $(:args "$@")
    fi
}

:info() {
    :log "INFO" "$(:args "$@")"
}

:warn() {
    :log "WARN" $(:args "$@") >&2
}

:fatal() {
    :log "FATAL" $(:args "$@") >&2
    exit 1
}

