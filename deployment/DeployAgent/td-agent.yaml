---
 - hosts: nodes
   vars:
     projectName: "{{ ifProjectName }}"
     userName: "{{ ifUserName }}"
     samplingInterval: 60
     deploymentServerUrl: "{{ ifReportingUrl }}"
     licenseKey: "{{ ifLicenseKey }}"
   become: yes
   become_method: sudo
   become_flags: '-E'
   tasks:
   - name: td-agent | Correct file permissions
     file:
       path: /var/log/messages
       owner: root
       group: root
       mode: 0645
     tags:
     - plugin-fix
   - name: td-agent | Install package dependencies - APT
     become: yes
     become_flags: '-E'
     apt: 
       name: "{{item}}" 
       state: latest
       force: yes
       allow_unauthenticated: yes
       update_cache: "{{ apt_update }}"
     with_items:
       - wget
     when: ansible_pkg_mgr == 'apt'
   - name: td-agent | Get TD gpg key
     become: yes
     become_flags: '-E'
     command: wget --no-check-certificate http://packages.treasuredata.com/GPG-KEY-td-agent -P {{ansible_env.HOME}}
     when: ansible_pkg_mgr == 'apt'
   - name: td-agent | Add TD gpg key
     become: yes
     shell: cat {{ansible_env.HOME}}/GPG-KEY-td-agent | sudo apt-key add -
     when: ansible_pkg_mgr == 'apt'
   - name: td-agent | Add TD repository
     apt_repository:
      repo: deb http://packages.treasuredata.com/2/ubuntu/xenial/ xenial contrib
      state: present
     when: ansible_pkg_mgr == 'apt'
   - name: td-agent | Install td-agent
     become: yes
     become_flags: '-E'
     apt: 
       name: "{{item}}" 
       state: latest
       force: yes
       allow_unauthenticated: yes
       update_cache: yes
     with_items:
       - td-agent
     when: ansible_pkg_mgr == 'apt'
   - name: Yum Repo | Add insightfinder repo
     yum_repository:
       name: insightrepo
       description: Insightfinder Repo
       baseurl: ftp://{{ groups['coordinator'][0] }}/pub/insightRepo
       enabled: yes
       gpgcheck: no
     when: ansible_pkg_mgr == 'yum'
   - name: td-agent | Install td-agent
     yum:
       name: td-agent
       state: latest
       disablerepo: '*'
       enablerepo: insightrepo
     when: ansible_pkg_mgr == 'yum'
   - name: td-agent | copy Insightfinder plugin
     copy:
       src: files/out_InsightFinder.rb
       dest: /etc/td-agent/plugin/out_InsightFinder.rb
       owner: root
       group: root
       mode: 0644
   - name: td-agent | Add config_file
     template:
       src: files/td-agent.conf.template
       dest: /etc/td-agent/td-agent.conf
       mode: 0644
     tags:
     - td-agent-conig
   - name: td-agent | Start td-agent daemon
     service:
      name: td-agent
      enabled: yes
      daemon_reload: yes
      state: restarted