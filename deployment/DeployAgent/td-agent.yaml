---
 - hosts: nodes
   vars:
     projectName: "{{ ifProjectName }}"
     userName: "{{ ifUserName }}"
     samplingInterval: 60
     deploymentServerUrl: "{{ ifReportingUrl }}"
     licenseKey: "{{ ifLicenseKey }}"
   become: yes
   become_method: sudo
   become_flags: '-E'
   tasks:
   - name: Install package dependencies - APT wget
     become: yes
     shell: "http_proxy={{ http_proxy }} apt-get install -y -f --allow-unauthenticated wget"
     when: ansible_pkg_mgr == 'apt'
   - name: Install package dependencies - APT python-software-properties
     become: yes
     ignore_errors: yes
     shell: "http_proxy={{ http_proxy }} apt-get install -y -f --allow-unauthenticated python-software-properties"
     when: ansible_pkg_mgr == 'apt'
   - name: td-agent | Get TD gpg key
     become: yes
     shell: "http_proxy={{ http_proxy }} wget --no-check-certificate http://packages.treasuredata.com/GPG-KEY-td-agent -P {{ansible_env.HOME}}"
     when: ansible_pkg_mgr == 'apt'
   - name: td-agent | Add TD gpg key
     become: yes
     shell: cat {{ansible_env.HOME}}/GPG-KEY-td-agent | sudo apt-key add -
     when: ansible_pkg_mgr == 'apt'
   - name: td-agent | Add TD repository
     become: yes
     shell: "http_proxy={{ http_proxy }} add-apt-repository 'deb http://packages.treasuredata.com/2/ubuntu/xenial/ xenial contrib'"
     when: ansible_pkg_mgr == 'apt'
   - name: td-agent | Install td-agent
     become: yes
     shell: "http_proxy={{ http_proxy }} apt-get install -y -f --allow-unauthenticated td-agent"
     when: ansible_pkg_mgr == 'apt'
   - name: Yum Repo | Add insightfinder repo
     yum_repository:
       name: insightrepo
       description: Insightfinder Repo
       baseurl: ftp://{{ groups['coordinator'][0] }}/pub/insightRepo
       enabled: yes
       gpgcheck: no
     when: ansible_pkg_mgr == 'yum'
   - name: td-agent | Install td-agent
     yum:
       name: td-agent
       state: latest
       disablerepo: '*'
       enablerepo: insightrepo
     when: ansible_pkg_mgr == 'yum'
   - name: td-agent | copy Insightfinder plugin
     copy:
       src: files/out_InsightFinder.rb
       dest: /etc/td-agent/plugin/out_InsightFinder.rb
       owner: root
       group: root
       mode: 0644
   - name: td-agent | Add config_file
     template:
       src: files/td-agent.conf.template
       dest: /etc/td-agent/td-agent.conf
       mode: 0644
     tags:
     - td-agent-conig
   - name: td-agent | Start td-agent daemon
     service:
      name: td-agent
      enabled: yes
      state: restarted
